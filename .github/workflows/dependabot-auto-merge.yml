# =============================================================================
# Dependabot Auto-Merge Workflow - SEC-014
# Automatically approve and merge Dependabot PRs for security patches
# =============================================================================

name: Dependabot Auto-Merge

on:
  pull_request:
    branches:
      - master
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Auto-approve and auto-merge Dependabot PRs
  # ---------------------------------------------------------------------------
  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest

    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-approve security patches
        # Auto-approve for security updates and patch/minor version updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge security patches
        # Auto-merge security updates only (not major version updates)
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: |
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major version updates
        # For major updates, just comment but don't auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **Major Version Update Detected**

              This PR updates a dependency to a new major version.
              Please review the breaking changes carefully before merging.

              **Dependency:** ${{ steps.metadata.outputs.dependency-names }}
              **Update Type:** ${{ steps.metadata.outputs.update-type }}

              Auto-merge has been skipped for this PR.`
            });

# =============================================================================
# Auto-Merge Strategy:
# =============================================================================
#
# This workflow implements a safe auto-merge strategy for Dependabot PRs:
#
# 1. Patch Updates (x.x.X):
#    - Auto-approve: YES
#    - Auto-merge: YES (after CI passes)
#    - Rationale: Bug fixes and security patches are safe
#
# 2. Minor Updates (x.X.x):
#    - Auto-approve: YES
#    - Auto-merge: NO
#    - Rationale: New features need review but are backward compatible
#
# 3. Major Updates (X.x.x):
#    - Auto-approve: NO
#    - Auto-merge: NO
#    - Comment: YES (warning about breaking changes)
#    - Rationale: Breaking changes require manual review
#
# Prerequisites:
# - Enable "Allow auto-merge" in repository settings
# - Configure branch protection rules:
#   - Require status checks to pass before merging
#   - Require CI/CD workflows to pass
#   - Require up-to-date branches
#
# Security:
# - Only runs for Dependabot bot account
# - Requires CI/CD to pass before merge
# - Uses squash merge to keep history clean
#
# =============================================================================
